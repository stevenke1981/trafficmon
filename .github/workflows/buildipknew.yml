name: Build OpenWrt trafficmon (Rust)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      TARGET: aarch64-unknown-linux-musl
      OPENWRT_ARCH: aarch64_cortex-a53
      OPENWRT_TARGET: mediatek/filogic
      SDK_URL: https://downloads.openwrt.org/releases/24.10.3/targets/mediatek/filogic/openwrt-sdk-24.10.3-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install required packages
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          clang \
          llvm \
          libc6-dev-i386 \
          unzip \
          xz-utils \
          zstd \
          gcc-aarch64-linux-gnu \
          file \
          aria2 \
          jq \
          pkg-config \
          libssl-dev \
          libpcap-dev \
          binutils \
          tar \
          gzip

    - name: Download SDK with axel (multithreaded)
      run: |
        sudo apt update
        sudo apt install -y axel zstd
        
        mkdir -p sdk
        SDK_URL="https://downloads.openwrt.org/releases/24.10.3/targets/mediatek/filogic/openwrt-sdk-24.10.3-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
        
        echo "Using axel for multithreaded SDK download..."
        axel -n 8 -o sdk/sdk.tar.zst "$SDK_URL"
        
        echo "Extracting SDK..."
        tar -I zstd -xf sdk/sdk.tar.zst -C sdk --strip-components=1
        echo "SDK extraction complete"

    - name: Set ENV Paths
      run: |
        echo "STAGING_DIR=$GITHUB_WORKSPACE/sdk/staging_dir" >> $GITHUB_ENV
        echo "PATH=$GITHUB_WORKSPACE/sdk/staging_dir/toolchain-aarch64_cortex-a53_gcc-13.3.0_musl/bin:$PATH" >> $GITHUB_ENV

    - name: Verify Toolchain
      run: |
        which aarch64-openwrt-linux-musl-gcc
        aarch64-openwrt-linux-musl-gcc --version

    - name: Install Rust stable & target
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: aarch64-unknown-linux-musl

    - name: Build with Built-in Target
      run: |
        export RUSTFLAGS="-C linker=aarch64-openwrt-linux-musl-gcc -C link-arg=-static"
        cargo build --release --target aarch64-unknown-linux-musl

    - name: Verify Binary
      run: |
        file target/aarch64-unknown-linux-musl/release/*
        ls -la target/aarch64-unknown-linux-musl/release/

    - name: Verify control file format
      run: |
        echo "=== Checking control file ==="
        if [ ! -f "openwrt/CONTROL/control" ]; then
          echo "ERROR: openwrt/CONTROL/control not found!"
          exit 1
        fi
        
        echo "Original control file contents:"
        cat openwrt/CONTROL/control
        echo ""
        
        # Fix Architecture field to match the actual target
        echo "Updating Architecture field to match target..."
        sed -i "s/^Architecture:.*/Architecture: $OPENWRT_ARCH/" openwrt/CONTROL/control
        
        echo "Updated control file contents:"
        cat openwrt/CONTROL/control
        echo ""
        
        echo "Checking for required fields:"
        grep -q "^Package:" openwrt/CONTROL/control && echo "✓ Package field found" || (echo "✗ Package field missing" && exit 1)
        grep -q "^Version:" openwrt/CONTROL/control && echo "✓ Version field found" || (echo "✗ Version field missing" && exit 1)
        grep -q "^Architecture:" openwrt/CONTROL/control && echo "✓ Architecture field found" || (echo "✗ Architecture field missing" && exit 1)
        
        # Verify Architecture matches
        ARCH_IN_FILE=$(grep "^Architecture:" openwrt/CONTROL/control | cut -d' ' -f2)
        if [ "$ARCH_IN_FILE" != "$OPENWRT_ARCH" ]; then
          echo "ERROR: Architecture mismatch!"
          echo "Expected: $OPENWRT_ARCH"
          echo "Found: $ARCH_IN_FILE"
          exit 1
        fi
        echo "✓ Architecture matches: $OPENWRT_ARCH"
        
        echo ""
        echo "Checking file format:"
        file openwrt/CONTROL/control
        
        # Check for Windows line endings
        if file openwrt/CONTROL/control | grep -q "CRLF"; then
          echo "WARNING: Control file has Windows line endings (CRLF), converting to Unix (LF)..."
          sed -i 's/\r$//' openwrt/CONTROL/control
        fi

    - name: Create IPK package manually
      run: |
        echo "Creating IPK package manually..."
        
        # Create artifacts directory
        mkdir -p artifacts
        
        # Create temporary directory for IPK construction
        mkdir -p ipk_build/control
        mkdir -p ipk_build/data/usr/bin
        
        # Copy binary
        cp target/aarch64-unknown-linux-musl/release/trafficmon ipk_build/data/usr/bin/
        chmod +x ipk_build/data/usr/bin/trafficmon
        
        # Copy and prepare control file
        cp openwrt/CONTROL/control ipk_build/control/
        
        # Create debian-binary
        echo "2.0" > ipk_build/debian-binary
        
        # Create control.tar.gz
        cd ipk_build/control
        tar -czf ../control.tar.gz .
        cd ..
        
        # Create data.tar.gz
        cd data
        tar -czf ../data.tar.gz .
        cd ..
        
        # Create the IPK
        ar r ../artifacts/trafficmon_0.3.0-1_${OPENWRT_ARCH}.ipk debian-binary control.tar.gz data.tar.gz
        
        cd ..
        echo "IPK created: artifacts/trafficmon_0.3.0-1_${OPENWRT_ARCH}.ipk"

    - name: Verify IPK package structure
      run: |
        echo "Verifying IPK package structure..."
        
        mkdir -p ipk_inspect
        cd ipk_inspect
        
        cp ../artifacts/trafficmon_0.3.0-1_${OPENWRT_ARCH}.ipk .
        
        echo "=== 1. Extract IPK with ar ==="
        ar x trafficmon_0.3.0-1_${OPENWRT_ARCH}.ipk
        
        echo "=== 2. Check extracted files ==="
        ls -la
        
        echo "=== 3. Check debian-binary ==="
        if [ -f "debian-binary" ]; then
          echo "debian-binary contents:"
          cat debian-binary
        else
          echo "ERROR: debian-binary missing"
          exit 1
        fi
        
        echo "=== 4. Check control.tar.gz ==="
        if [ -f "control.tar.gz" ]; then
          echo "control.tar.gz contents:"
          tar -tzf control.tar.gz
          echo ""
          echo "control file contents:"
          tar -xzf control.tar.gz -O ./control
        else
          echo "ERROR: control.tar.gz missing"
          exit 1
        fi
        
        echo "=== 5. Check data.tar.gz ==="
        if [ -f "data.tar.gz" ]; then
          echo "data.tar.gz contents:"
          tar -tzf data.tar.gz | head -20
          echo ""
          echo "Binary file info:"
          tar -xzf data.tar.gz ./usr/bin/trafficmon
          file ./usr/bin/trafficmon
          ls -lh ./usr/bin/trafficmon
        else
          echo "ERROR: data.tar.gz missing"
          exit 1
        fi
        
        cd ..
        rm -rf ipk_inspect

    - name: Upload generated IPK
      uses: actions/upload-artifact@v4
      with:
        name: trafficmon-ipk
        path: artifacts/*.ipk
        if-no-files-found: error