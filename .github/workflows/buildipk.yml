name: Build OpenWrt trafficmon (Rust)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      TARGET: aarch64-unknown-linux-musl
      OPENWRT_TARGET: mediatek/filogic
      SDK_URL: https://downloads.openwrt.org/releases/24.10.3/targets/mediatek/filogic/openwrt-sdk-24.10.3-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install required packages
      run: |
        sudo apt update
        sudo apt install -y \
          build-essential \
          clang \
          llvm \
          libc6-dev-i386 \
          unzip \
          xz-utils \
          zstd \
          gcc-aarch64-linux-gnu \
          file \
          aria2 \
          jq \
          pkg-config \
          libssl-dev \
          libpcap-dev \
          binutils \
          tar \
          gzip

    - name: Download SDK with axel (multithreaded)
      run: |
        sudo apt update
        sudo apt install -y axel zstd
        
        mkdir -p sdk
        SDK_URL="https://downloads.openwrt.org/releases/24.10.3/targets/mediatek/filogic/openwrt-sdk-24.10.3-mediatek-filogic_gcc-13.3.0_musl.Linux-x86_64.tar.zst"
        
        echo "使用 axel 多線程下載 SDK..."
        axel -n 8 -o sdk/sdk.tar.zst "$SDK_URL"
        
        echo "開始解壓縮 SDK..."
        tar -I zstd -xf sdk/sdk.tar.zst -C sdk --strip-components=1
        echo "SDK 解壓縮完成"

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Add MUSL target
      run: rustup target add $TARGET

    - name: Prepare Cargo cross-compile config
      run: |
        TOOLCHAIN_BIN="${GITHUB_WORKSPACE}/sdk/staging_dir/toolchain-aarch64_cortex-a53_gcc-13.3.0_musl/bin"
        mkdir -p .cargo
        printf "[target.%s]\nlinker = \"%s/aarch64-openwrt-linux-musl-gcc\"\nar = \"%s/aarch64-openwrt-linux-musl-ar\"\n" "$TARGET" "$TOOLCHAIN_BIN" "$TOOLCHAIN_BIN" > .cargo/config.toml
        cat .cargo/config.toml

    - name: Check project structure
      run: |
        echo "當前目錄結構:"
        find . -name "*.rs" -o -name "Cargo.toml" | sort
        echo "src 目錄內容:"
        ls -la src/ 2>/dev/null || echo "src 目錄不存在"

    - name: Build with dynamic linking
      run: |
        echo "嘗試動態鏈接..."
        # 清理之前的構建
        cargo clean
        # 使用動態鏈接
        RUSTFLAGS="-C target-feature=-crt-static" cargo build --release --target $TARGET

    - name: Build Rust binary (alternative approach)
      run: |
        echo "檢查 Cargo.toml 配置..."
        cat Cargo.toml
        
        echo "嘗試直接編譯..."
        # 直接使用 rustc 編譯（繞過 Cargo）
        rustc --version
        ls -la src/main.rs
        
        # 先檢查 Cargo 是否能正常運行
        cargo check --verbose
        
        # 如果 cargo check 成功，再嘗試構建
        cargo build --release --target $TARGET
        mkdir -p openwrt_bin
        cp target/$TARGET/release/trafficmon openwrt_bin/

    - name: Verify binary file
      run: |
        echo "驗證二進制文件..."
        file target/$TARGET/release/trafficmon
        ls -la target/$TARGET/release/trafficmon
        
        # 檢查是否為有效的 ELF 文件
        readelf -h target/$TARGET/release/trafficmon || echo "不是有效的 ELF 文件"

    - name: Prepare OpenWrt package
      run: |
        echo "設置 OpenWrt 包..."
        
        # 創建目錄結構
        mkdir -p sdk/package/trafficmon/files/usr/bin
        mkdir -p sdk/package/trafficmon/files/etc/init.d
        mkdir -p sdk/package/trafficmon/files/etc/config
        
        # 複製 Rust 編譯結果
        echo "複製 trafficmon 二進制文件..."
        if [ -f "target/$TARGET/release/trafficmon" ]; then
          cp target/$TARGET/release/trafficmon sdk/package/trafficmon/files/usr/bin/
          chmod +x sdk/package/trafficmon/files/usr/bin/trafficmon
          echo "二進制文件複製成功"
        else
          echo "錯誤: 二進制文件不存在"
          find target/ -name "trafficmon" -type f
          exit 1
        fi
        
        # 複製配置文件
        cp openwrt/files/etc/init.d/trafficmon sdk/package/trafficmon/files/etc/init.d/
        cp openwrt/files/etc/config/trafficmon sdk/package/trafficmon/files/etc/config/
        cp openwrt/Makefile sdk/package/trafficmon/
        
        chmod +x sdk/package/trafficmon/files/etc/init.d/trafficmon
        
        echo "包文件準備完成"

    - name: Create IPK package from prebuilt files
      run: |
        echo "從預建文件創建 IPK 包..."
        
        # 直接使用預先建立的目錄結構
        mkdir -p ipk_build
        
        # 複製整個文件結構（包括 CONTROL）
        cp -r openwrt/files/* ipk_build/
        cp -r openwrt/CONTROL ipk_build/
        
        # 確保目錄結構正確
        mkdir -p ipk_build/usr/bin
        
        # 複製二進制文件
        cp target/$TARGET/release/trafficmon ipk_build/usr/bin/
        chmod +x ipk_build/usr/bin/trafficmon
        
        # 創建 IPK
        mkdir -p artifacts
        cd ipk_build
        
        tar --owner=0 --group=0 -czf ../data.tar.gz ./usr ./etc
        tar --owner=0 --group=0 -czf ../control.tar.gz ./CONTROL
        
        cd ..
        echo "2.0" > debian-binary
        
        ar r artifacts/trafficmon_0.3.0-1_aarch64_cortex-a53.ipk debian-binary control.tar.gz data.tar.gz
        
        # 清理
        rm -f data.tar.gz control.tar.gz debian-binary
        rm -rf ipk_build
        
        echo "IPK 創建成功："
        ls -la artifacts/

    - name: Upload generated IPK
      uses: actions/upload-artifact@v4
      with:
        name: trafficmon-ipk
        path: artifacts/*.ipk
        if-no-files-found: error

    - name: Verify IPK package structure
      run: |
        echo "檢驗 IPK 包結構..."
        
        # 創建檢驗目錄
        mkdir -p ipk_inspect
        
        # 進入目錄
        cd ipk_inspect
        
        # 複製 IPK 文件
        cp ../artifacts/trafficmon_0.3.0-1_aarch64_cortex-a53.ipk .
        
        echo "=== 1. 使用 ar 解包 ==="
        ar x trafficmon_0.3.0-1_aarch64_cortex-a53.ipk
        
        echo "=== 2. 檢查解包後的文件 ==="
        ls -la
        
        echo "=== 3. 檢查 debian-binary ==="
        if [ -f "debian-binary" ]; then
          cat debian-binary
        else
          echo "錯誤: 缺少 debian-binary 文件"
        fi
        
        echo "=== 4. 檢查 control.tar.gz ==="
        if [ -f "control.tar.gz" ]; then
          echo "control.tar.gz 內容:"
          tar -tzf control.tar.gz
          echo ""
          echo "control 文件內容:"
          tar -xzf control.tar.gz -O ./control 2>/dev/null || tar -xzf control.tar.gz -O ./CONTROL/control 2>/dev/null || echo "無法讀取 control 文件"
        else
          echo "錯誤: 缺少 control.tar.gz 文件"
        fi
        
        echo "=== 5. 檢查 data.tar.gz ==="
        if [ -f "data.tar.gz" ]; then
          echo "data.tar.gz 內容:"
          tar -tzf data.tar.gz
          echo ""
          echo "二進制文件信息:"
          tar -xzf data.tar.gz -O ./usr/bin/trafficmon 2>/dev/null | file - || echo "無法讀取二進制文件"
        else
          echo "錯誤: 缺少 data.tar.gz 文件"
        fi
        
        echo "=== 6. 完整的文件樹 ==="
        if [ -f "data.tar.gz" ]; then
          echo "完整的文件結構:"
          tar -tzf data.tar.gz | sort
        fi
        
        # 清理
        cd ..
        rm -rf ipk_inspect